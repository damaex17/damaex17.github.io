<!DOCTYPE html> <html lang = "en"> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="yandex-verification" content="e801bebf4149cd4c" /> <title> Fraud Detection with GPS and Airplanes | inversegravity.net </title> <meta name="description" content=" Fraud Detection with Haversine "> <meta name="keywords" content="fraud detection algorithm unrealistic distance between transactions haversine"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Maximilian Weber"> <meta property="article:section" content=""> <meta property="article:tag" content="fraud detection algorithm unrealistic distance between transactions haversine"> <meta property="article:published_time" content="2019-04-17 00:00:00 +0000"> <meta property="og:url" content="https://inversegravity.net/2019/fraud-detection-with-GPS-and-airplanes/"> <meta property="og:title" content=" Fraud Detection with GPS and Airplanes | inversegravity.net "> <meta property="og:description" content=" Fraud Detection with Haversine "> <meta property="og:site_name" content="Maximilian Weber"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content=""> <meta name="twitter:title" content=" Fraud Detection with GPS and Airplanes | inversegravity.net "> <meta name="twitter:description" content=" Fraud Detection with Haversine "> <meta property="og:image" content="https://inversegravity.net/assets/images/airplane.jpg" /> <meta name="twitter:image" content="https://inversegravity.net/assets/images/airplane.jpg" /> <!-- Canonical link tag --> <link rel="canonical" href="https://inversegravity.net/2019/fraud-detection-with-GPS-and-airplanes/"> <link rel="alternate" type="application/rss+xml" title="inversegravity.net" href="https://inversegravity.net/feed.xml"> <!-- rel prev and next --> <link rel="stylesheet" href="https://inversegravity.net/assets/css/main.css"> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="https://inversegravity.net/">inversegravity<span>.net</span></a></h1> <ul class="navbar"> <li><a href="https://inversegravity.net/about/">About me</a></li> <li><a href="https://inversegravity.net/feed.xml" target="_blank">RSS</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"><time datetime="2019-04-17T00:00:00+00:00" itemprop="datePublished">Apr 17, 2019</time></p> <h1 class="post-title" itemprop="name headline">Fraud Detection with GPS and Airplanes</h1> </header> <div class="post-content" itemprop="articleBody"> <h3 id="fraud-case">Fraud Case</h3> <p>I was the victim of credit card fraud in 2012. Criminals skimmed my debit card and emptied the bank account in a matter of hours. My bank fully refunded me but when checking the transactions, I figured that this was preventable.</p> <table> <thead> <tr> <th>Date UTC</th> <th>Transaction Text</th> <th style="text-align: right">Value</th> </tr> </thead> <tbody> <tr> <td>08.05.2012-02:47</td> <td>GA Verfügung EMV GEB.EU 5,99 EU 100,00 <code class="highlighter-rouge">BERLIN</code> Backshop GER</td> <td style="text-align: right">€ -105,99</td> </tr> <tr> <td>08.05.2012-14:30</td> <td>GA-Verfügung EC-GA MAGNET0 GEB.EU 7,50 CAD 300 <code class="highlighter-rouge">TORONTO</code> MCU WELLESLEY B CAN</td> <td style="text-align: right">€ -239,41</td> </tr> <tr> <td>08.05.2012-15:03</td> <td>GA-Verfügung EC-GA MAGNET0 GEB.EU 0,00 MXN 363,60 <code class="highlighter-rouge">CANCUN</code> TKUKULKAN K MEXGA MXN</td> <td style="text-align: right">€ -21,60</td> </tr> <tr> <td>08.05.2012-15:31</td> <td>GA-Verfügung EC-GA MAGNET0 GEB.EU 7,50 CAD 500 <code class="highlighter-rouge">TORONTO</code> MCU WELLESLEY B CAN</td> <td style="text-align: right">€ -394,01</td> </tr> <tr> <td>08.05.2012-15:03</td> <td>GA-Verfügung EC-GA MAGNET0 GEB.EU 0,00 MXN 657,60 <code class="highlighter-rouge">CANCUN</code> TKUKULKAN K MEXGA MXN</td> <td style="text-align: right">€ -39,06</td> </tr> <tr> <td>08.05.2012-15:16</td> <td>GA-Verfügung EC-GA MAGNET0 GEB.EU 0,00 MXN 7419,60 <code class="highlighter-rouge">CANCUN</code> TKUKULKAN K MEXGA MXN</td> <td style="text-align: right">€ -440,68</td> </tr> <tr> <td>08.05.2012-17:31</td> <td>GA-Verfügung EC-GA MAGNET0 GEB.EU 7,50 CAD 280 <code class="highlighter-rouge">TORONTO</code> MCU WELLESLEY B CAN</td> <td style="text-align: right">€ -222,56</td> </tr> </tbody> </table> <p>This pattern continued until my bank account was empty.</p> <p><strong>GA-Verfügung:</strong> Customer is at an ATM machine (German: Geldautomat) and has removed the money</p> <p><strong>EMV:</strong> Europay, Mastercard or Visa Authorization with PIN</p> <p><strong>EC-GA MAGNET0:</strong> Authorization via the magnetic strip of the card</p> <p>The first transaction at 02:47 was an ATM withdrawal by me and this wasn’t necessarily the machine where my card data was stolen. Later the fraudulent transactions start from Toronto Canada and Cancun Mexico.</p> <h3 id="detection">Detection</h3> <p>Banks verify your account balance almost in real time on every withdrawal to prevent you from breaking your credit limits. The information the bank receives from payment networks or vendor terminals has the same content as the transaction list above. During this check, the following fraud detection algorithm could be implemented to block the fraudulent transactions and prevent the money withdrawal, lock the compromised card or ask the user for additional verification via a mobile app.</p> <h3 id="how-to-detect">How to detect</h3> <p>Calculate the distance between two given cities and make sure it’s realistic to travel the distance in the given time via airplane.</p> <p><img src="/assets/images/airplane.jpg" alt="picture of an airplane" style="float: center; padding: 10px 10px 10px 10px;" /></p> <h3 id="implementation">Implementation</h3> <p>Get the Latitude and Longitude of a given City/Country for example via <a href="https://cloud.google.com/maps-platform/">python geopy</a> or <a href="https://simplemaps.com/resources/free-country-cities">SimpleMaps</a>.</p> <table> <thead> <tr> <th>City</th> <th>latitude</th> <th>lonitude</th> </tr> </thead> <tbody> <tr> <td>Berlin</td> <td>52.516667</td> <td>13.4</td> </tr> <tr> <td>Cancun</td> <td>21.172361</td> <td>-86.829546</td> </tr> <tr> <td>Toronto</td> <td>43.666667</td> <td>-79.416667</td> </tr> </tbody> </table> <p>With the <a href="https://en.wikipedia.org/wiki/Haversine_formula">Haversine Formula</a>, we can calculate the distance on a sphere with a radius of 6371 km (Earth).</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a = sin²(Δφ/2) + cos φ1 ⋅ cos φ2 ⋅ sin²(Δλ/2)

c = 2 * atan2( √a, √(1−a) )

d = R * c
</code></pre></div></div> <p>Where φ represent the latitudes, and λ represent the longitudes. We then need to calculate the delta between the time of the two transactions and calculate if an airplane (max 925kph/0.26kps) could actually make it.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">import</span> <span class="nn">argparse</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan2</span><span class="p">,</span> <span class="n">radians</span>

<span class="k">def</span> <span class="nf">calc_dist</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">6371</span>
    <span class="n">lat1</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pos1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">lon1</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pos1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">lat2</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pos2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">lon2</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pos2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span><span class="o">-</span><span class="n">lon1</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlat</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlon</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">atan2</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a</span><span class="p">))</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>
    <span class="k">return</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_time</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span> <span class="n">time2</span><span class="p">):</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">Y</span><span class="si">%</span><span class="s">m</span><span class="si">%</span><span class="s">dT</span><span class="si">%</span><span class="s">H</span><span class="si">%</span><span class="s">M</span><span class="si">%</span><span class="s">S"</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span> <span class="n">tf</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time2</span><span class="p">,</span> <span class="n">tf</span><span class="p">)</span>
    <span class="n">time_delta</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">time_delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">kph_to_kps</span><span class="p">(</span><span class="n">kph</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">kph</span><span class="p">)</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_realistic_dist</span><span class="p">(</span><span class="n">kps</span><span class="p">,</span> <span class="n">time_delta</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">kps</span><span class="o">*</span><span class="n">time_delta</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">possible</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">realistic_distance</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="n">realistic_distance</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="s">"nope"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="s">"yes"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-s"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"max speed &lt;int&gt; kph; default=925"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"speed"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">925</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"pos1"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"latitude and longitude position 1: &lt;52.443099:13.622028&gt;"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"pos2"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"latitude and longitude position 2: &lt;52.522613:13.404837&gt;"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"time1"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"ISO8601 timestamp 1: &lt;20190101T172215&gt;"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"time2"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"ISO8601 timestamp 2: &lt;20190101T172265&gt;"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">pos1</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">pos2</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">time1</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">time2</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">calc_dist</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pos1</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">pos2</span><span class="p">)</span>
    <span class="n">time_delta</span> <span class="o">=</span> <span class="n">calc_time</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">time1</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">time2</span><span class="p">)</span>
    <span class="n">kps</span> <span class="o">=</span> <span class="n">kph_to_kps</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
    <span class="n">realistic_distance</span> <span class="o">=</span> <span class="n">calc_realistic_dist</span><span class="p">(</span><span class="n">kps</span><span class="p">,</span> <span class="n">time_delta</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"distance pos1 and pos2: "</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s">" km"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"kilometer per second: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">kps</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s">" kps"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"delta time1 and time2: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_delta</span><span class="p">)</span> <span class="o">+</span> <span class="s">" seconds"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"possible: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">possible</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">realistic_distance</span><span class="p">)))</span>

<span class="k">if</span>  <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</code></pre></div></div> <p>Let’s try my MVP with the first transaction.</p> <table> <tbody> <tr> <td>08.05.2012-02:47</td> <td>Berlin</td> <td>52.516667</td> <td>13.4</td> </tr> <tr> <td>08.05.2012-14:30</td> <td>Toronto</td> <td>43.666667</td> <td>-79.416667</td> </tr> </tbody> </table> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python ./algo-mvp.py 52.516667:13.4 43.666667:-79.416667 20120508T024700 20120508T143000
distance pos1 and pos2: 6476.68 km
kilometer per second: 0.26 kps
delta time1 and time2: 42180.0 seconds
possible: yes
</code></pre></div></div> <p>So this is a possible transaction. Let’s check the next pair.</p> <table> <tbody> <tr> <td>08.05.2012-14:30</td> <td>Toronto</td> <td>43.666667</td> <td>-79.416667</td> </tr> <tr> <td>08.05.2012-15:03</td> <td>Cancun</td> <td>21.172361</td> <td>-86.829546</td> </tr> </tbody> </table> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python ./algo-mvp.py 43.666667:-79.416667 21.172361:-86.829546 20120508T143000 20120508T150300
distance pos1 and pos2: 2593.52 km
kilometer per second: 0.26 kps
delta time1 and time2: 1980.0 seconds
possible: nope
</code></pre></div></div> <p>At this point, the fraud detection would report an issue and the bank could decline the transaction. The damage to the bank would be just the first transaction instead of multiple ones and the damage of thousands of Euros.</p> <h3 id="production">Production</h3> <p>I would utilize a microservice to run the detection. The decision regarding accepting or declining a transaction has to be made quickly. I would optimize the code for this and utilize a Redis based cache to hold the time and lat/long pair of the last transactions of all customers. A TTL of one day should be enough because in one day our airplane can go anywhere on this planet. Military personnel traveling by fighter jets will, unfortunately, trigger the fraud implementation.</p> <h3 id="conclusion">Conclusion</h3> <p>Fraud detection requires many approaches and is highly depending on the use case. It’s important to look at fraud cases and analyze them. Nowadays hopefully all banks utilize machine learning to get a good understanding of their customers behavior and flag potential fraud in real-time. Batch processing once per day is no longer acceptable in my opinion. Customers deserve to be protected by modern real time fraud detection technology.</p> <p>My approach is simple and can help to prevent fraud in cases of unrealistic distances between transactions.</p> </div> <span><div style="text-align:center">[ <a href="/tag/security/"><code class="highligher-rouge"><nobr>security</nobr></code></a> ]</div></span> <aside class="share"> <div style="text-align:center"><p>If you liked this article, please share it on <a href="http://twitter.com/share?text=Fraud Detection with GPS and Airplanes&amp;url=https://inversegravity.net/2019/fraud-detection-with-GPS-and-airplanes/&amp;via=" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a></p></div> </aside> </article> <footer class="site-footer"> <div class="container"> <small class="block">&copy; 2019 Maximilian Weber &middot; &lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a> </small> </div> </footer> </main> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-138082100-1']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </body> </html>
